---
layout: post
title:  "分布式系统专题第七章-可靠消息最终一致性"
date:   2022-02-05 18:00:00 +0800
categories: 分布式系统
tags: system
comments: 1
---
# 可靠消息最终一致性
可靠消息最终一致性方案是指当事务发起方执行完成本地事务后发出一条消息到消息中间件，事务参与方(消息消费者)一定能够接收到消息并处理事务成功，此方案强调的是只要消息发给事务参与方，则最终事务要达到一致。
* 假设消息中间件是可靠的
* 以下内容场景：共有两个微服务交互，用户服务和积分服务，用户服务负责添加用户，积分服务负责增加积分。
* 以下内容使用`RocketMQ`作为演示

## 流程描述
Producer 即MQ发送方，本例中是用户服务，负责新增用户。MQ订阅方即消息消费方，本例中是积分服务，负责新增积分。
### 1、Producer 发送事务消息
Producer （MQ发送方）发送事务消息至MQ Server，MQ Server将消息状态标记为Prepared（预备状态），注意此时这条消息消费者（MQ订阅方）是无法消费到的。
本例中，Producer 发送 ”增加积分消息“ 到MQ Server。

### 2、MQ Server回应消息发送成功
MQ Server接收到Producer 发送给的消息则回应发送成功表示MQ已接收到消息。

### 3、Producer 执行本地事务
Producer 端执行业务代码逻辑，通过本地数据库事务控制。本例中，Producer 执行添加用户操作。

### 4、消息投递
若Producer 本地事务执行成功则自动向MQServer发送commit消息，MQ Server接收到commit消息后将”增加积分消息“ 状态标记为可消费，此时MQ订阅方（积分服务）即正常消费消息；  
若Producer 本地事务执行失败则自动向MQServer发送rollback消息，MQ Server接收到rollback消息后 将删除”增加积分消息“ 。  
MQ订阅方（积分服务）消费消息，消费成功则向MQ回应ack，否则将重复接收消息。这里ack默认自动回应，即程序执行正常则自动回应ack。  

### 5、事务回查
如果执行Producer端本地事务过程中，执行端挂掉，或者超时，MQ Server将会不停的询问同组的其他 Producer
来获取事务执行状态，这个过程叫事务回查。MQ Server会根据事务回查结果来决定是否投递消息。  
以上主干流程已由RocketMQ实现，对用户侧来说，用户需要分别实现本地事务执行以及本地事务回查方法，因此只需关注本地事务的执行状态即可。  

## 示例流程图
![cap](/img/in-post/system/8.jpg)

## 总结
可靠消息最终一致性就是保证消息从生产方经过消息中间件传递到消费方的一致性，本案例使用了RocketMQ作为消息中间件，RocketMQ主要解决了两个功能：
* 1、本地事务与消息发送的原子性问题。
* 2、事务参与方接收消息的可靠性。
可靠消息最终一致性事务适合执行周期长且实时性要求不高的场景。引入消息机制后，同步的事务操作变为基于消息执行的异步操作, 避免了分布式事务中的同步阻塞操作的影响，并实现了两个服务的解耦。

# 最大努力通知
> 解决分布式环境下，跨网络、跨服的柔性事务解决方案，多见于充值等场景

## 最大努力通知方案要求主要包含以下两个方面：
* 1）有一定的消息重复通知机制：接收通知方有可能无法接收到通知，一定要具有重复通知的机制。
* 2）消息校对机制：在重复通知仍然没有通知到对方，可由接收通知方主动查询信息。

## 与可靠消息最终一致性的区别
### 1）解决方案思想不同
可靠消息最终一致性：发起通知方需要保证将消息发出去，并且将消息发到接收通知方，消息的可靠性关键由发起通知方来保证。
最大努力通知：发起通知方尽最大的努力将业务处理结果通知为接收通知方，但是可能消息接收不到，此时需要接收通知方主动调用发起通知方的接口查询业务处理结果，通知的可靠性关键在接收通知方。

### 2）业务场景不同
可靠消息一致性：关注的是交易过程的事务一致，以异步的方式完成交易。
最大努力通知：关注的是交易后的通知事务，即将交易结果可靠的通知出去。

### 3）结束解决方向不同
可靠消息一致性：要解决消息从发出到接收的一致性，即消息发出并且被接收到。
最大努力通知：无法保证消息从发出到接收的一致性，只提供消息接收的可靠性机制。可靠机制是，最大努力的将消息通知给接收方，当消息无法被接收方接收时，由接收方主动查询消息（业务处理结果）。