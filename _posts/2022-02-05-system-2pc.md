---
layout: post
title:  "分布式系统专题第四章-2PC和3PC"
date:   2022-02-05 17:00:00 +0800
categories: 分布式系统
tags: system
comments: 1
---
> 前面已经学习了分布式事务的基础理论，以理论为基础，针对不同的分布式场景业界常见的解决方案有2PC、TCC、可靠消息最终一致性、最大努力通知这几种。

# 两段式提交（2PC）
两阶段提交又称2PC,2PC是一个非常经典的**强一致、中心化的原子提交协议**  
* 中心化是指协议中有两类节点,即一个协调者（coordinator）和N个参与者（partcipant）
* 两个阶段是指第一阶段：**投票阶段** 和第二阶段：**提交/执行阶段**。
> 计算机中部分关系数据库如Oracle、MySQL支持两阶段提交协，数据库支持的2PC又叫做`XA Transactions`

## 第一阶段：投票阶段
第一阶段主要分为三步
![cap](/img/in-post/system/3.jpg)
### 1、事务询问
**协调者** 向所有的 **参与者** 发送事务预处理请求，称之为`Prepare`，并开始等待各 **参与者** 的响应。
### 2、执行本地事务
各个 **参与者** 节点执行本地事务操作,但在执行完成后并不会真正提交数据库本地事务。
### 3、各参与者向协调者反馈事务询问的响应
如果 **参与者** 成功执行了事务操作,那么就反馈给协调者 Yes 响应,表示事务可以执行,如果没有 **参与者** 成功执行事务,那么就反馈给协调者 No 响应,表示事务不可以执行。

> 第一阶段执行完后，会有两种可能。  
> 1、所有都返回Yes.   
> 2、有一个或者多个返回No。

## 第二阶段：提交/执行阶段（成功流程）
> 成功条件：所有参与者都返回Yes。

成功流程第二阶段主要分为两步
![cap](/img/in-post/system/4.jpg)
### 1、发出提交请求
**协调者** 向 **所有参与者** 节点发出Commit请求。
所有的  **参与者**  反馈给 **协调者** 的信息都是Yes,那么就会执行事务提交

### 2、事务提交
**参与者** 收到Commit请求之后,就会正式执行本地事务Commit操作,并在完成提交之后释放整个事务执行期间占用的事务资源

## 第二阶段：提交/执行阶段（异常流程）
> 异常条件：任何一个 **参与者** 向 **协调者** 反馈了 No 响应,或者等待超时之后,协调者尚未收到所有**参与者**的反馈响应。

![cap](/img/in-post/system/5.jpg)
异常流程第二阶段也分为两步
### 1、发送回滚请求
**协调者** 向所有参与者节点发出 `RoollBack` 请求.
### 2、事务回滚
​ **参与者** 接收到`RoollBack`请求后,会回滚本地事务。

## 2PC缺点
* 同步阻塞问题。执行过程中，所有参与节点都是事务阻塞型的。当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态。(1pc准备阶段，只执行sql，而不提交，并且占用数据库连接资源)  

* 单点故障。由于协调者的重要性，一旦协调者发生故障。参与者会一直阻塞下去。尤其在第二阶段，协调者发生故障，那么所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作。（如果是协调者挂掉，可以重新选举一个协调者，但是无法解决因为协调者宕机导致的参与者处于阻塞状态的问题）  

* 数据不一致。在二阶段提交的阶段二中，当协调者向参与者发送commit请求之后，发生了局部网络异常或者在发送commit请求过程中协调者发生了故障，这回导致只有一部分参与者接受到了commit请求。而在这部分参与者接到commit请求之后就会执行commit操作。但是其他部分未接到commit请求的机器则无法执行事务提交。于是整个分布式系统便出现了数据部一致性的现象。  

* 二阶段无法解决的问题：协调者在发出commit消息之后宕机，而唯一接收到这条消息的参与者同时也宕机了。那么即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否被已经提交。  
